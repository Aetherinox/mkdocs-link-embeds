# ---------------------------------------------------------------------------------------
#   @parent     : github workflow
#   @desc       : pypi release
#   @author     : Aetherinox
#   @url        : https://github.com/Aetherinox
# ---------------------------------------------------------------------------------------

name: "Pypi Release"

# ---------------------------------------------------------------------------------------
#   environment variables
# ---------------------------------------------------------------------------------------

env:
    ASSIGN_USER:              Aetherinox
    BOT_NAME_1:               AdminServ
    BOT_NAME_2:               AdminServX
    BOT_NAME_DEPENDABOT:      dependabot[bot]

# ---------------------------------------------------------------------------------------
#   triggers
# ---------------------------------------------------------------------------------------

on:
    workflow_dispatch:
      inputs:

        # ---------------------------------------------------------------------------------------
        #   Python Build Type
        #   setup and build
        # ---------------------------------------------------------------------------------------

        opt_build_type:
          type: choice
          description: Build Type
          options:
          - py setup.py
          - py build

        # ---------------------------------------------------------------------------------------
        #   Pypi Service
        #   Official or Test
        # ---------------------------------------------------------------------------------------

        opt_pypi_type:
          type: choice
          description: Pypi Service
          options:
          - Official
          - Test

        # ---------------------------------------------------------------------------------------
        #   STABLE:       stable version
        #   CANDIDATE:    release candidate
        # ---------------------------------------------------------------------------------------

        PRERELEASE:
          type: choice
          description: 📦 Build Type
          options:
          - Stable
          - Release Candidate

# ---------------------------------------------------------------------------------------
#   jobs
# ---------------------------------------------------------------------------------------

jobs:
  build:
    name: Prepare Package
    runs-on: ubuntu-latest
    outputs:
      package_version: ${{ steps.get_package_version.outputs.PACKAGE_VERSION }}
      package_filename: ${{ steps.build_handle_tarball.outputs.PACKAGE_VERSION }}
    steps:
      - name: ✅ Start
        run: | 
              echo "Starting build: ${{ github.event.inputs.opt_build_type }}" / ${{ inputs.opt_build_type }}

      - name: ☑️ Checkout
        uses: actions/checkout@v4

      - name: Get Package Version
        id: get_package_version
        run: |
          VER=$(cat VERSION)
          echo "PACKAGE_VERSION=$VER" >> $GITHUB_OUTPUT

      # ---------------------------------------------------------------------------------------
      #   setup python
      # ---------------------------------------------------------------------------------------

      - name: 🐍 Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # ---------------------------------------------------------------------------------------
      #   install pip, setuptools, wheel, twine, etc
      # ---------------------------------------------------------------------------------------

      - name: 🐍 Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine build

      # ---------------------------------------------------------------------------------------
      #   build python script
      # ---------------------------------------------------------------------------------------

      - name: ☸️ Build tarball
        id: build_handle_tarball
        run: |
          if [ "${{ github.event.inputs.opt_build_type }}" = "py setup.py" ]; then
            echo "Starting build: py setup.py"
            python setup.py sdist
          fi

          if [ "${{ github.event.inputs.opt_build_type }}" = "py build" ]; then
            echo "Starting build: py build"
            python -m build . --sdist
          fi

          PACKAGE=$(find *tar.gz -type f -printf "%f\n")
          echo "PACKAGE_FILENAME=dist/$PACKAGE" >> $GITHUB_OUTPUT

      - name: Print Package Info
        id: build_print_package
        run: |
          echo ${{ needs.build.outputs.PACKAGE_VERSION }}
          echo ${{ env.PACKAGE_VERSION }}
          echo ${{ env.PACKAGE_FILENAME }}

      - name: "🪢 Twine › Check Dist"
        run: |
          twine check dist/*
  
      - name: Store the distribution packages
        uses: actions/upload-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

# ---------------------------------------------------------------------------------------
#   Pypi: Official Stable Release
# ---------------------------------------------------------------------------------------

  pypi-publish-official:
    name: >-
      📦 PyPI › Official
    if: ${{ github.event.inputs.opt_pypi_type == 'Official' }}
    needs:
    - build
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing
    environment:
      name: Orion
      url: https://pypi.org/p/mkdocs-link-embeds-plugin

    steps:
    - name: "Download › Saved Artifacts"
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/
  
  #  - name: Release 📦 PyPI Official
   #   uses: pypa/gh-action-pypi-publish@release/v1
  #    with:
   #     user: __token__
   #     #password: ${{ secrets.PYPI_API_TOKEN }}
   #     packages-dir: dist/
    #    print-hash: true

# ---------------------------------------------------------------------------------------
#   Pypi: Test API
# ---------------------------------------------------------------------------------------

  pypi-publish-test:
    name: >-
      📦 PyPI › Test Api
    if: ${{ github.event.inputs.opt_pypi_type == 'Test' }}
    needs:
    - build
    runs-on: ubuntu-latest
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing
    environment:
      name: Orion
      url: https://test.pypi.org/p/mkdocs-link-embeds-plugin

    steps:
    - name: "Download › Saved Artifacts"
      uses: actions/download-artifact@v4
      with:
        name: python-package-distributions
        path: dist/

    #- name: Release 📦 PyPI Test
    #  uses: pypa/gh-action-pypi-publish@release/v1
     # with:
     #   repository-url: https://test.pypi.org/legacy/

  dist-release:
    name: >-
      📦 Github › Release
    runs-on: ubuntu-latest
    needs: [ build, pypi-publish-official, pypi-publish-test ]
    env:
      PACKAGE_VERSION: ${{ needs.build.outputs.package_version }}
    if: |
      always()
      && contains(needs.*.result, 'success')
      && !contains(needs.*.result, 'failure')
    permissions:
      contents: write
    steps:

      # ---------------------------------------------------------------------------------------
      #   Checkout
      # ---------------------------------------------------------------------------------------

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # ---------------------------------------------------------------------------------------
      #   [ Artifact ]: Download
      # ---------------------------------------------------------------------------------------

      - name: "Download › Saved Artifacts"
        uses: actions/download-artifact@v4
        with:
          name: python-package-distributions
          path: dist/

      # ---------------------------------------------------------------------------------------
      #   [ Tag ]: Pre Create
      # ---------------------------------------------------------------------------------------

      - name: "🔖 [ Tag ]: Pre Create ${{ env.PACKAGE_VERSION }}"
        uses: rickstaa/action-create-tag@v1
        id: "tag_create"
        with:
          tag: ${{ env.PACKAGE_VERSION }}
          tag_exists_error: false
          message: "Latest release"

      # ---------------------------------------------------------------------------------------
      #   [ Tag ]: Confirm
      # ---------------------------------------------------------------------------------------

      - name: "🔖 [ Tag ]: Confirm ${{ env.PACKAGE_VERSION }}"
        run: |
          echo "Tag already present: ${{ env.TAG_EXISTS }}"
          echo "Tag already present: ${{ steps.tag_create.outputs.tag_exists }}"

      # ---------------------------------------------------------------------------------------
      #   [ Release Candidate ]: Checksum
      # ---------------------------------------------------------------------------------------

      - name: "🆔 [ Checksum ]: Stable"
        id: checksum-st
        if: ${{ startsWith( inputs.PRERELEASE, false ) }}
        run: |
          filename_zip="${{ inputs.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}.zip"
          sha256="$(shasum --algorithm 256 ${filename_zip} | awk '{ print $1 }')"
          shasum --algorithm 256 ${filename_zip} > SHA256SUMS.txt
          echo "FILE_ZIP=${filename_zip}" >> $GITHUB_ENV
          echo "SHA256SUM=${sha256}" >> $GITHUB_ENV
          echo ${{ env.SHA256SUM }}


      - name: "🆔 [ Checksum ]: Release Candidate"
        id: checksum-rc
        if: ${{ startsWith( inputs.PRERELEASE, true ) }}
        run: |
          filename_zip="${{ inputs.PLUGIN_NAME }}-${{ env.PACKAGE_VERSION }}-rc.${{ inputs.VERSION_RC }}.zip"
          sha256="$(shasum --algorithm 256 ${filename_zip} | awk '{ print $1 }')"
          shasum --algorithm 256 ${filename_zip} > SHA256SUMS.txt
          echo "FILE_ZIP=${filename_zip}" >> $GITHUB_ENV
          echo "SHA256SUM=${sha256}" >> $GITHUB_ENV
          echo ${{ env.SHA256SUM }}

      # ---------------------------------------------------------------------------------------
      #   Contributor Images
      # ---------------------------------------------------------------------------------------

      - name: "🥸 [ Contributors ]: Generate"
        id: contribs-generate
        uses: jaywcjlove/github-action-contributors@main
        with:
          filter-author: (renovate\[bot\]|renovate-bot|dependabot\[bot\])
          output: CONTRIBUTORS.svg
          avatarSize: 42
