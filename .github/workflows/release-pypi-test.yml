name: "Pypi Release - Test"

on:
    workflow_dispatch:
      inputs:
        opt_build_type:
          type: choice
          description: Build Type
          options:
          - py setup.py
          - py build
        opt_pypi_type:
          type: choice
          description: Pypi Service
          options:
          - Official
          - Test

# alias python='python3'

jobs:
  build:
    name: Prepare Package
    runs-on: ubuntu-latest
    # Specifying a GitHub environment is optional, but strongly encouraged
    environment: Orion
    permissions:
      id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing

    steps:
      - name: ‚úÖ Start
        run: | 
              echo "Starting build: ${{ github.event.inputs.opt_build_type }}" / ${{ inputs.opt_build_type }}

      - name: ‚òëÔ∏è Checkout
        uses: actions/checkout@v3
      - name: üêç Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.x"

      - name: üêç Install Build Tools
        run: |
          python -m pip install --upgrade pip
          pip install setuptools wheel twine build

      - name: ‚ò∏Ô∏è Build tarball
        run: |
          if [ "${{ github.event.inputs.opt_build_type }}" = "py setup.py" ]; then
            echo "Starting build: py setup.py"
            python setup.py sdist
          fi

          if [ "${{ github.event.inputs.opt_build_type }}" = "py build" ]; then
            echo "Starting build: py build"
            python -m build . --sdist
          fi

      - name: "ü™¢ Twine: Check Dist"
        run: |
          twine check dist/*
      
      build-pypi-test:
          name: "Publish: Pypi Test"
          runs-on: ubuntu-latest
          # Specifying a GitHub environment is optional, but strongly encouraged
          environment: Orion
          permissions:
            id-token: write  # IMPORTANT: this permission is mandatory for trusted publishing

          steps:
          - name: "Pypi : Test API"
            uses: pypa/gh-action-pypi-publish@release/v1
            if: ${{ github.event.inputs.opt_build_type == 'Test' }}
            with:
              user: __token__
              #password: ${{ secrets.PYPI_API_TEST_TOKEN }}
              repository-url: https://test.pypi.org/legacy/
              packages-dir: dist/
              print-hash: true

          - name: "Pypi : Official API"
            uses: pypa/gh-action-pypi-publish@release/v1
            if: ${{ github.event.inputs.opt_build_type == 'Official' }}
            with:
              user: __token__
              #password: ${{ secrets.PYPI_API_TEST_TOKEN }}
              repository-url: https://test.pypi.org/legacy/
              packages-dir: dist/
              print-hash: true
