name: "Pypi Release - Test"

on:
    workflow_dispatch:
      inputs:
        opt_build_type:
          type: choice
          description: Build Type
          options:
          - py setup.py
          - py build

# alias python='python3'

jobs:
    build-n-publish:
        name: Build and publish Python 🐍 distributions 📦 to PyPI and TestPyPI
        runs-on: ubuntu-latest
    
        steps:
        - name: ✅ Start
          run: | 
                echo "Starting build: ${{ github.event.inputs.opt_build_type }}" / ${{ inputs.opt_build_type }}

        - name: ☑️ Checkout
          uses: actions/checkout@v3
        - name: 🐍 Set up Python
          uses: actions/setup-python@v4
          with:
            python-version: "3.x"

        - name: 🐍 Install Build Tools
          run: |
            python -m pip install --upgrade pip
            pip install setuptools wheel twine build

        - name: ☸️ Build tarball
          run: |
            if [ "${{ github.event.inputs.opt_build_type }}" = "py setup.py" ]; then
              echo "Starting build: py setup.py"
              python setup.py sdist
            fi

            if [ "${{ github.event.inputs.opt_build_type }}" = "py build" ]; then
              echo "Starting build: py build"
              python -m build . --sdist
            fi

        - name: "🪢 Twine: Check Dist"
          run: |
            twine check dist/*
            
        - name: Publish package to TestPyPI
          uses: pypa/gh-action-pypi-publish@release/v1
          with:
              permissions:
                id-token: write
            user: __token__
            #password: ${{ secrets.PYPI_API_TEST_TOKEN }}
            repository-url: https://test.pypi.org/legacy/
            packages-dir: dist/
            print-hash: true
